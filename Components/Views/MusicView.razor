@using CommunityToolkit.Maui.Core.Primitives
  @inject AudioManager AudioManager
  @inject IJSRuntime JSRuntime
  @implements IDisposable

<NavigationLock OnBeforeInternalNavigation="OnBeforeInternalNavigation"></NavigationLock>

@if (Current != null)
{

    <Glass Class="@(IsMusicViewActive ? "toggle-music" : "music")" Blur="20" BackgroundColor="rgba(66, 245, 209,0.1)" Border="@BorderMusic">
        @if (IsMusicViewActive)
        {
            <div>
                <img src="./images/backArrow.svg" width="24" height="24" style="position:absolute;top:8px" @onclick="ToggleMusicView" />
                <img src="./images/menu-bar.svg" width="28" height="28" style="position:absolute;top:8px;right:23px;" @onclick="ToggleMenubarDialog" />
            </div>
            <div class="toggle-controls">
                @if(IsVideoMode)
                {
                    <video class="video-ctrl" src="@Current.VideoStreamInfo.Url" autoplay muted @ref="video">

                    </video>
                }
                else
                {
                    <img class="cover-image" src="@ThumbnailUrl" />
                }
                <div style="display:flex;align-items:center;color:white;margin-top:40px">
                    <div>
                        <p class="ellepsis"><b>@Current.Video.Title</b></p>
                        <p class="ellepsis">@Current.Video.Author</p>
                    </div>
                    <div @onclick="ToggleLike"  style="width: 50px;height: 50px;display: flex;justify-content: center;">
                        <img src=@(IsCurrentSongLiked ? "./images/solid-heart.svg" :"./images/heart.svg") height="32" width="32" />
                    </div>
                </div>

                <div style="bottom:60px">
                    <div style="display:flex;width:100%;align-items:center;justify-content:space-between;margin-top:10px">
                        <div>@(TimeSpan.FromSeconds(CurrentTime).ToMusicString())</div>
                        <div>@(TimeSpan.FromSeconds(Duration).ToMusicString())</div>
                    </div>

                    @* <SliderRange Value="@((int)CurrentTime)" Max="@((int)Duration)" Style="width:70vw;padding-left:4px;padding-right:4px"
                    MouseDown="MouseDown" MouseUp="MouseUp"
                    OnChange="OnSliderChange" /> *@

                    <div style="width:70vw;padding-left:4px;margin-top:8px" id="sliderContainer" class="bg-transparent">
                        <input type="range" value="@CurrentTime" max="@((int)Duration)" @onchange="(e)=>OnSliderChange(int.Parse(e.Value.ToString()))"
                        @onmousedown="MouseDown"
                        @onmouseup="MouseUp" @ontouchstart="MouseDown" @ontouchend="MouseUp"
                        @onclick:stopPropagation="true"
                               ValueChanged="(d)=>OnSliderChange(d)"></input>
                    </div>


                    <div style="margin-top:30px;display: flex;width: 100%;justify-content: space-between;" @onclick:stopPropagation="true">
                        <img src="./images/backward.svg" height="32" width="32" @onclick="PlayPrevious"/>
                        @if (IsPlaying)
                        {
                            <img src="./images/pause.svg" height="32" width="32" @onclick="PlayPauseToggle"/>
                        }
                        else
                        {
                            <img src="./images/play.svg" height="32" width="32" @onclick="PlayPauseToggle" />
                        }                        
                        <img src="./images/forward.svg" height="32" width="32" @onclick="PlayNext" />
                    </div>
                </div>
                

            </div>
        }
        else
        {
            <div class="controls" @onclick="ToggleMusicView">
                <img class="img" src="@ThumbnailUrl" />
                <div style="display:flex;flex-direction:column;align-items:flex-start;margin-left:10px;color:white">
                    <p class="ellepsis"><b>@Current.Video.Title</b></p>
                    <p class="ellepsis">@Current.Video.Author</p>
                    <div></div>
                </div>
                @if (IsPlaying)
                {
                    <img src="./images/pause.svg" height="32" width="32" @onclick="PlayPauseToggle" @onclick:stopPropagation="true" />
                }
                else
                {
                    <img src="./images/play.svg" height="32" width="32" @onclick="PlayPauseToggle" @onclick:stopPropagation="true" />
                }
            </div>
            <MudProgressLinear Color="Color.Secondary" Value="@CurrentTime" Max="@Duration" Size="Size.Small" Style="margin-top:-10px;margin-left:80px;margin-right:80px;width:calc(100vw - 160px)" />
        }
    </Glass>

    <Scrollable OnCloseButtonClick="ToggleMenubarDialog" IsActive="@isMenubarVisible">
        <div class="menubar-cover">
            <img class="menubar-cover-image" src="@ThumbnailUrl" />
            <div style="display:flex;flex-direction:column;margin-top:12px;">
                <span class="ellepsis-menubar"><b>@Current.Video.Title</b></span>
                <span class="ellepsis-menubar">@Current.Video.Author</span>
            </div>
        </div>

        <div class="menubar-items">
            
            @foreach (var menubarItem in MusicMenubar.Instance.MenubarItems)
            {
                switch (menubarItem.Type)
                {
                    case MenubarItem.MenubarItemType.AddToPlayList:
                        {
                            <div class="menubar-option" @onclick="ToggleAddToPlaylistDialog">
                                <img src="./images/add-to-playlist.svg" height="32" width="32" @onclick:stopPropagation="true" />
                                <p style="margin-left: 15px;"><b>@menubarItem.Text</b></p>
                            </div>
                            break;
                        }
                    case MenubarItem.MenubarItemType.Download:
                        {
                            <div class="menubar-option">
                                <img src="./images/download.svg" height="32" width="32" @onclick:stopPropagation="true" />
                                <p style="margin-left: 15px;"><b>@menubarItem.Text</b></p>
                            </div>
                            break;
                        }
                    case MenubarItem.MenubarItemType.Share:
                        {
                            <div class="menubar-option">
                                <img src="./images/share.svg" height="32" width="32" @onclick:stopPropagation="true" />
                                <p style="margin-left: 15px;"><b>@menubarItem.Text</b></p>
                            </div>
                            break;
                        }
                }

            }
        </div>
    </Scrollable>
    <Scrollable OnCloseButtonClick="ToggleAddToPlaylistDialog" IsActive="@isAddToPlaylistVisible">
        <PlaylistView video="AudioManager.Current!.Video" OnOperationCompletedClicked="ToggleAddToPlaylistDialog" IsPlaylistSelectionEnable="true"/>
    </Scrollable>
}




@code
{
    public static bool IsMusicViewActive { get; set; } = false;
    private string BorderMusic =>$"2px solid rgba(255, 0, 0,{(IsMusicViewActive?0:0.4)})";
    private bool isMenubarVisible = false;
    private bool isAddToPlaylistVisible = false;
    private bool CanUpdateSlider = true;

    private AudioItem? Current;
    private double CurrentTime;
    private double Duration;
    private string ThumbnailUrl;
    private bool IsPlaying = false;
    private bool IsCurrentSongLiked => UserSetting.Instance.IsLiked(AudioManager.Current!.Video);
    public static Action? OnMusicViewInit;
    private bool IsVideoMode { get; set; } = false;
    private DateTime LastTime = DateTime.Now;

    private ElementReference video;

    private async void ToggleMusicView()
    {
        IsMusicViewActive = !IsMusicViewActive;

        if(IsMusicViewActive)
        {
            await Task.Delay(200);
            await JSRuntime.InvokeVoidAsync("seekVideo", video, AudioManager.Audio.CurrentTime.TotalSeconds);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        MainPage.OnBackButtonPress = HandleBackButtonForMusicView;

        AudioManager.Init();

        AudioManager.Audio.OnMediaStateChange += MediaStateChanged;
        AudioManager.Audio.OnTimeUpdate += OnTimeUpdate;
        AudioManager.Audio.OnLoadedMetadata += OnLoadedMetadata;
    }

    bool HandleBackButtonForMusicView()
    {
        if (IsMusicViewActive)
        {
            IsMusicViewActive = false;
            return true;
        }
        return false;
    }

    private void OnBeforeInternalNavigation(LocationChangingContext context)
    {
        if (IsMusicViewActive)
        {
            ToggleMusicView();
            context.PreventNavigation();
        }
    }


    private async void MediaStateChanged(object sender,MediaStateChangedEventArgs e)
    {
        await InvokeAsync(async() =>
        {
            IsPlaying = AudioManager.IsPlaying;

            if (IsVideoMode && IsMusicViewActive)
            {
                if(e.NewState==MediaElementState.Playing)
                    await JSRuntime.InvokeVoidAsync("playVideo", video);
                else
                    await JSRuntime.InvokeVoidAsync("pauseVideo", video);
            }


            StateHasChanged();
        });
    }
    private async void OnLoadedMetadata(object sender)
    {
        await InvokeAsync(() =>
        {
            Current = AudioManager.Current;
            OnMusicViewInit?.Invoke();

            if (Current is not null)
            {
                ThumbnailUrl = Current.Video.Thumbnails.MaxBy(x => x.Resolution.Area)!.Url;
            }

            Duration = AudioManager.Current!.Video.Duration.GetValueOrDefault().TotalSeconds;
            StateHasChanged();
        });
    }

    private void OnTimeUpdate(object sender)
    {
        if (!CanUpdateSlider || (DateTime.Now-LastTime).TotalSeconds<0.5)
            return;

        LastTime = DateTime.Now;
        InvokeAsync(() =>
        {
            CurrentTime = AudioManager.Audio.CurrentTime.TotalSeconds;
            StateHasChanged();
        });
    }

    private void MouseDown()
    {
        CanUpdateSlider = false;
    }
    private async void MouseUp()
    {
        await Task.Delay(100);
        CanUpdateSlider = true;
    }

    public void Dispose()
    {
        AudioManager.Audio.OnMediaStateChange -= MediaStateChanged;
    }

    private async void OnSliderChange(int value)
    {
        AudioManager.Audio.CurrentTime=TimeSpan.FromSeconds(value);

        if(IsVideoMode)
        {
            //add extra few seconds as seeking takes time
            if (value + 3 < AudioManager.Audio.Duration.TotalSeconds)
                value+=3;
            await JSRuntime.InvokeVoidAsync("window.seekVideo", video, value);
        }
    }

    private async void PlayNext()
    {
        await AudioManager.PlayNextAsync();
    }
    private async void PlayPrevious()
    {
        await AudioManager.PlayPreviousAsync();
    }

    private async void PlayPauseToggle()
    {
        if(!AudioManager.IsPlaying)
        {
            AudioManager.Audio.Play();
        }
        else
        {
            AudioManager.Audio.Pause();
        }
    }

    private void ToggleLike()
    {
        if (IsCurrentSongLiked) UserSetting.Instance.RemoveFromLike(AudioManager.Current!.Video);
        else UserSetting.Instance.AddToLike(AudioManager.Current!.Video);
    }

    private void ToggleMenubarDialog()
    {
        IsMusicViewActive = false;
        isMenubarVisible = !isMenubarVisible;
    }

    private void ToggleAddToPlaylistDialog()
    {
        isMenubarVisible = false;
        isAddToPlaylistVisible = !isAddToPlaylistVisible;
    }
}


<style>
    .ellepsis {
        width: 64vw;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .music {
        height: 86px;
        width: 100%;
        position: absolute;
        bottom: 50px;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        border: 1px solid rgba(66, 245, 209,0.5);
        padding: 4px;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        transition: height 0.5s,bottom 0.5s;
    }

    .toggle-music {
        height: 100vh;
        width: 100%;
        position: absolute;
        bottom: 0px;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        border: 1px solid rgba(66, 245, 209,0.5);
        padding: 20px;
        transition: height 0.5s, bottom 0.5s;
    }

    .video-ctrl
    {
        margin-top:6px;
        width:80vw;
        height:60vh;
        object-fit: cover;
    }
    .cover-image {
        height: 50vh;
        width: 50vh;
    }

    .controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .toggle-controls {
        height: 85vh;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .music-control {
        margin-top: 10px;
        display: flex;
        width: 60%;
        justify-content: space-between;
    }

    .img {
        border-radius: 50%;
        border: 2px solid rgba(66, 245, 209,0.5);
        display: flex;
        align-items: center;
        width: 50px;
        height: 50px;
        margin-top: -2px;
        margin-left: 10px;
    }

    .menubar-items 
    {
        margin-left: 30px;
        margin-right: 30px;
        height: 70%;
        margin-top: 90px;
        padding-top: 180px;
        padding-left: 12px;
        padding-right: 12px;
        background-color: rgba(66, 245, 209, 0.1);
    }
    .menubar-cover
    {
        display: flex;
        justify-content: center;
        position: absolute;
        width: 100%;
        top: 25px;
        flex-direction: column;
        align-items: center;
    }

    .menubar-cover-image
    {
        height: 20vh;
        width: 20vh;
        box-shadow: 10px 10px 5px 0px rgba(0, 0, 0, 0.75);
    }

    .menubar-option
    {
        display:flex;
        align-items: center;
        margin-bottom: 8px;
    }

    .ellepsis-menubar {
        width: 40vw;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>