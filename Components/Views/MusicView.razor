  @inject AudioManager AudioManager
  @inject IJSRuntime JSRuntime
  @implements IDisposable

@if (Current != null)
{

    <Glass Class="@(isMusicViewActive ? "toggle-music" : "music")" Blur="20" BackgroundColor="rgba(66, 245, 209,0.1)" Border="@BorderMusic">
        @if (isMusicViewActive)
        {
            <div class="toggle-controls" @onclick="ToggleMusicView">
                <img class="cover-image" src="@ThumbnailUrl" />
                <div style="display:flex;flex-direction:column;align-items:flex-start;margin-left:10px;color:white;margin-top:20px">
                    <p class="ellepsis"><b>@Current.Video.Title</b></p>
                    <p class="ellepsis">@Current.Video.Author</p>
                    <div></div>
                </div>

                <div style="position:absolute; bottom:60px">
                    <div style="display:flex;width:100%;align-items:center;justify-content:space-between;margin-top:40px">
                        <div>@(TimeSpan.FromSeconds(CurrentTime).ToString(@"mm\:ss"))</div>
                        <div>@(TimeSpan.FromSeconds(Duration).ToString(@"mm\:ss"))</div>
                    </div>
                    <SliderRange Value="@((int)CurrentTime)" Max="@((int)Duration)" Style="width:70vw;padding-left:4px;padding-right:4px" OnChange="OnTimeChange" />

                    <div style="margin-top:20px;margin-top: 10px;display: flex;width: 100%;justify-content: space-between;" @onclick:stopPropagation="true">
                        <img src="./images/backward.svg" height="32" width="32" @onclick="PlayPrevious"/>
                        @if (IsPlaying)
                        {
                            <img src="./images/pause.svg" height="32" width="32" @onclick="PlayPauseToggle"/>
                        }
                        else
                        {
                            <img src="./images/play.svg" height="32" width="32" @onclick="PlayPauseToggle" />
                        }                        
                        <img src="./images/forward.svg" height="32" width="32" @onclick="PlayNext" />
                    </div>
                </div>
                

            </div>
        }
        else
        {
            <div class="controls" @onclick="ToggleMusicView">
                <img class="img" src="@ThumbnailUrl" />
                <div style="display:flex;flex-direction:column;align-items:flex-start;margin-left:10px;color:white">
                    <p class="ellepsis"><b>@Current.Video.Title</b></p>
                    <p class="ellepsis">@Current.Video.Author</p>
                    <div></div>
                </div>
                @if (IsPlaying)
                {
                    <img src="./images/pause.svg" height="32" width="32" @onclick="PlayPauseToggle" @onclick:stopPropagation="true" />
                }
                else
                {
                    <img src="./images/play.svg" height="32" width="32" @onclick="PlayPauseToggle" @onclick:stopPropagation="true" />
                }
            </div>
            <MudProgressLinear Color="Color.Secondary" Value="@CurrentTime" Max="@Duration" Size="Size.Small" Style="margin-top:-10px;margin-left:80px;margin-right:80px;width:80vw" />
        }
    </Glass>
}




@code
{
    private bool isMusicViewActive { get; set; } = false;
    private string BorderMusic =>$"2px solid rgba(255, 0, 0,{(isMusicViewActive?0:0.4)})";

    private AudioItem? Current;
    private double CurrentTime;
    private double Duration;
    private string ThumbnailUrl;
    private bool IsPlaying = false;

    private void ToggleMusicView()
    {
        isMusicViewActive = !isMusicViewActive;
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await AudioManager.InitialzePlayerAsync(JSRuntime);
        await AudioManager.AddSongAsync("wGCMSWEuLsI");
        await AudioManager.AddSongEndAsync("AMuRRXCuy-4");
        await AudioManager.AddSongEndAsync("d5crO6w6NYs");
        await AudioManager.AddSongEndAsync("hjfzFVw2Zjo");
        await AudioManager.PlayAsync();

        AudioManager.OnAudioPlayPlaused += OnAudioPlayPlaused;
        AudioManager.Audio.OnTimeUpdate += OnTimeUpdate;
        AudioManager.Audio.OnLoadedMetadata += OnLoadedMetadata;
    }


    private void OnAudioPlayPlaused(object sender)
    {
        Current = AudioManager.Current;
        if(Current is not null)
        {
            ThumbnailUrl= Current.Video.Thumbnails.MaxBy(x => x.Resolution.Area)!.Url;
        }

        IsPlaying = AudioManager.IsPlaying;
        StateHasChanged();
    }
    private async void OnLoadedMetadata(object sender)
    {
        Duration = await AudioManager.Audio.GetDuration();
        StateHasChanged();
    }
    private async void OnTimeUpdate(object sender)
    {
        CurrentTime = await AudioManager.Audio.GetCurrentTime();
        StateHasChanged();
    }

    public void Dispose()
    {
        AudioManager.OnAudioPlayPlaused -= OnAudioPlayPlaused;
    }

    private async void OnTimeChange(int value)
    {
        await AudioManager.Audio.SetCurrentTime(value);
    }

    private async void PlayNext()
    {
        await AudioManager.PlayNextAsync();
    }
    private async void PlayPrevious()
    {
        await AudioManager.PlayPreviousAsync();
    }

    private async void PlayPauseToggle()
    {
        if(!IsPlaying)
        {
            await AudioManager.Audio.Play();
            IsPlaying = true;
        }
        else
        {
            await AudioManager.Audio.Pause();
            IsPlaying = false;
        }
    }

}


<style>
    .ellepsis {
        width: 64vw;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .music {
        height: 86px;
        width: 100%;
        position: absolute;
        bottom: 50px;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        border-color: 1px solid rgba(66, 245, 209,0.5);
        padding: 4px;
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        transition: height 0.5s,bottom 0.5s;
    }

    .toggle-music {
        height: 100vh;
        width: 100%;
        position: absolute;
        bottom: 70px;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        border-color: 1px solid rgba(66, 245, 209,0.5);
        padding: 20px;
        transition: height 0.5s, bottom 0.5s;
    }

    .cover-image {
        height: 50vh;
        width: 50vh;
    }

    .controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .toggle-controls {
        height: 85vh;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .music-control {
        margin-top: 10px;
        display: flex;
        width: 60%;
        justify-content: space-between;
    }

    .img {
        border-radius: 20px;
        border-color: 1px solid rgba(66, 245, 209,0.5);
        display: flex;
        align-items: center;
        width: 60px;
        height: 50px;
        margin-top: -2px;
        margin-left: 10px;
    }
</style>